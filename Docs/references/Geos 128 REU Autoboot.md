Reference: Geos 128 REU Autoboot: 
Youtube link: https://www.youtube.com/watch?v=4Er8f1u0-fY
Reference from Jani:
https://www.cbm128.com/Cartridges/Cartridges.html
https://blog.worldofjani.com/?p=1600 Making a C128 Cartridge
https://blog.worldofjani.com/?p=879 making a C64 Cartridge


Youtube transcribe:
GEOS 128 REU Autoboot Mysteries Unraveled
0:00 Hi, it's Matt. I've got my Comm 128 set up today, and if you remember, this was my favorite home computer from the 8-bit era, and it still is, even to this day. This particular flat 128 was my very first vintage machine that I picked up when I got into retro about 5 years ago, so it has a special place in my heart. But today I wanted to continue the tradition of answering questions no one was even asking.

0:26 With that in mind, what we've got here is the GEOS 128 desktop. Now, I've booted into GEOS from a real 1581 disk and a 1750 RAM Expansion Unit (REU). I've got this RAM disk set up on the REU unit. You can see that here. Now I'm going to exit to basic. The next thing I'm going to do is I'm going to eject the disk and hit the reset button. Watch what happens.

1:03 Look how fast GEOS 128 comes back up from basic when you've got a RAM expansion installed. That's just insanely, insanely quick.

1:14 So let's take a look at the GEOS manual here and see what capabilities the REU adds to GEOS. "Perhaps the greatest single performance improvement that you can make to your Commodore now that you're using GEOS is obtaining one of the Commodore RAM Expansion Units." The 1700 adds 128K of RAM, the 1764 adds 256K, and the 1750 that we've got here adds 512K. GEOS Kernel supports the RAM expansion using the 128 configure file. I'll launch here, and it provides all these capabilities here.

1:53 The first one is this 1541/1571 RAM Drive, which you already saw. I've got turned on there. It's a simulated disk drive implemented entirely in RAM. Anything you save on it should be copied to a real disk because it will be lost at the end of a session.

2:07 It also supports this Shadow 1541 Drive, which is RAM that's used to remember data that's been previously read from a disk, so basically a disk cache. Anything that's been read once is cached and then it's read faster the second time.

2:20 Additionally, there's this feature called DMA for Move Data. The RAM Expansion Unit is capable of moving large amounts of data much faster than the code in the C64 or C128 computer. Move Data allows for DMA transfer of large blocks of data, which makes noticeable difference when, for example, scrolling around a GEOPAINT document. Now, I talked about the RAM expansion in a very early video, but effectively there's a DMA controller on there that allows one byte of data to be moved per clock cycle, so it can reach speeds up to almost a megabyte a second, which is just insane if you think about how fast that is on a computer with such a limited amount of RAM. It really is blazingly fast.

3:06 And the last thing here is this Fast Reboot, which you can see that I've got enabled here. And if this option is selected, then pressing the reset key will cause GEOS to reload from the RAM expansion and look for a desktop. That's what I just demonstrated. And that's one of the most powerful capabilities if you need to move back and forth between applications and GEOS, if you need to go back to basic to program something or load some other software. So that's a really cool capability.

3:31 And of course, if you power cycle the machine down like so, and then you turn it back on, of course nothing's going to happen, right? We've cleared main memory and we've cleared the RAM expansion. And just to be sure, let me press reset. Yep, of course, if you clear the REU, RAM reboot is not going to work. There is no question about that.

3:54 So the experiment I want to try today is using the 1541 Ultimate 2+ cartridge. I want to see if we can preserve the state of the REU, save it to the USB stick, and then load the REU upon cold start so we never have to boot GEOS from a disk ever again. Let's see what we can do with that.

4:19 First step is to remove the old RAM expansion here and to plug in the Ultimate 2+ okay. Now I'm power on the machine. Okay, the next thing we need to do is enable the REU in the Ultimate 2+, and we can do that through the command console via Telnet because I don't have 40 columns hooked up. I'm only using 80 columns on the 128 today. So if we hit the F2 key, we can go down here into the cartridge settings and we can turn on the RAM expansion unit. We can set it to 512K, just like our 1750. Then we can back out and save the changes to flash just like that.

5:04 Now I'm going to reboot the machine one more time just to make sure those changes have taken effect. And we're going to boot back into GEOS 128 to prepare our RAM disk. Oh, I got to put the disk in the drive for that to work. There we go. And of course, this is going to take a lot longer than booting just from memory, so I might fast forward this bit if it takes a little bit too long. Booting from disk is still pretty quick on a Comm 128 because it does have the 2 MHz CPU, and it does have the fast and burst mode transfers on the 1571 and 1581 drives, so it's actually pretty quick. I guess there's no need to fast forward right now. We'll just wait for it. There it goes.

5:58 Okay, so the last thing I want to do before I exit back to basic to take a snapshot of the REU state is to prepare the RAM disk by copying 128 desktop here onto the RAM disk. Oops, I think I missed. Let me try again. Yeah, there I got it that time. And the reason we want to do this is because if that file is on the RAM disk, it will load from the RAM disk instead of the floppy disk after the system comes back up. Let's check it. There we go. 128 desktop is there. Now we can quit back to basic like so.

6:36 Now the main memory is preserved, and the REU state is preserved. We didn't clear anything out. We haven't hard-powered the machine yet. So if we go back to our 1541 Ultimate 2+, and we go into our USB drive, if we hit the F5 key here, we can go down to C64 machine, C128 machine, and save REU memory. And I'm just going to call this GEOS 128. There we go. We've got an REU save state of everything that's in it right now.

7:10 And one more thing I want to do before I power cycle the machine is I want to turn on "Reload it Startup" so that this REU file will be loaded every time we power on the machine. We don't have to come back into this UI every time. And to make sure that works, we go back down here to cartridge settings. We can see that the preload image is set. We just need to turn it on like that and then save the flash.

7:36 With that done, we can power cycle the machine. Now watch the little light on the USB stick when I power the machine back on. It will flash indicating the REU file is getting loaded. Yep, there it goes. And now I'm going to hit reset and see what happens. Okay, nothing happened. We really didn't expect that was going to work because the REU doesn't work like a ROM cartridge, and the CPU can't access the REU memory directly. It has to go through that DMA controller, so something else has to be going on here. It's not just the state of the REU that's making this quick boot possible.

8:19 Let's have a quick look at this page by World of Jani about making C128 cartridges. This site is a great resource if you haven't seen it before; there's a link in the description. But here he talks about how C128 cartridges work. Basically, the functionality is different than in a C64. Maximum size has been doubled to 32K, and an EPROM socket (U36) has been provided inside the machine in addition to the cartridge port. So that's an interesting thing: you now have an EPROM socket where you can put basically an internal cartridge as well as the external cartridge here. And in fact, GEOS did sell a boot ROM that you'd put into that U36 option ROM, and it would boot GEOS immediately on power up, just like Kickstart works on an Amiga, for example.

9:04 Now, you can have both a function ROM and a cartridge at the same time, but we'll talk about that in a second. An external cartridge is referred to as an external function ROM, and the internal EPROM socket is referred to an internal function ROM. An 8-bit machine can only see 64K at a time, and the same goes for the C128. Yep, the C128 still has the same 16-bit address bus that the C64 has, so it can only see 64K at a time. The processor can only see 64K at a time. What happens is there's an MMU that's used for bank switching, and we'll talk about that in a minute.

9:37 There are two areas in the memory where cartridges can be located: at 8000 or C000. And a cartridge can be started from either of these areas. The memory is managed by an MMU chip and not a PLA like in the Commodore 64. Basically for Commodore 128 auto-start, when the machine is booted, the presence of a cartridge is checked. If either GAME or EXROM are low, this means that the cartridge is made for a C64, and so the machine will boot into C64 mode. Otherwise, it checks for an identifier: the "CBM" string at 8007 or C007. And this is done for the external and internal slots. The banks are checked in the following order: external mid, external high, internal mid, and internal high. What this means is that you can use an external ROM cartridge as well as a U36 cartridge or EPROM at the same time if it'll boot the external one first. And if that gracefully exits, it'll boot the internal one second. And if that gracefully exits, then it will go back to basic. And I verified this works with the 128 device manager. It boots up, runs its diagnostics, hands off from the external to the internal, runs a second time, and then hands off to basic. So that does work, and it's kind of an interesting thing.

10:50 What we want to know is how GEOS 128 REU boots the machine since it's not a cartridge or a U36 option ROM. So if we look at the GEOS 128 user manual addendum here on page 52, we've got "Returning to the Desktop from Basic." "If the programs you have run well in the basic interpreter do not disturb the memory space between C000 and C080, and the NMI vector has not changed, then you can reboot the desktop." So there's our first clue: we need to examine C000 to C080 after GEOS has exited to basic. I want to point out that the 128 can also auto-boot from disk, but that uses an entirely different process.

11:33 So I've already booted the machine back into GEOS. We've got our RAM disk set up here. It's empty, but it doesn't matter, it's fine. I'm going to jump into basic. The 128 has a much improved basic from the 64. It includes sound and graphics commands, disk commands. It also has a built-in sprite editor as well as a machine language monitor, which will come in use for what we're going to do today.

12:00 We know we want to look at the memory space from C000 to C080, so we'll just do this: we'll just take a look at the memory from C000 to C080. Hmm, yeah, that doesn't look like much of anything there. There's a bunch of nothing and some numbers. But as we've already learned, the 128 CPU can only see 64K at a time, so it uses banking to give the machine a full 128K, and the monitor lets us look at the different banks. So we can use a command like this: 1 C000 to 1 C80, where the "1" specifies bank one. Fun fact: the system was designed to bank switch between four 64K banks for a total of 256K of RAM, and commands like BANK in basic support this, but the PCB and the MMU don't, so banks two and three just mirror banks zero and one.

12:59 Aha! Now that looks like something of interest. This is, in fact, you can see the GEOS boot text string right there. This is the GEOS boot routine in memory. But we didn't see a "CBM" string in C007 in either bank zero or bank one, so auto-start isn't working like a cartridge or option ROM. But just to be sure, let's check the other memory location that cartridge auto-start string could be in. That's 8007. No "CBM" string there. And 1 8007. Okay, no "CBM" string there.

13:35 So should we try and see if the boot code in C000 at bank one is what's actually auto-starting the system? What we can do is we can save that block of memory to disk, reboot the system, and then load that block of memory again and see if that causes the auto-start to work. The way we do that is we use SAVE. We're going to call the file 1C000 just to keep track of it. I'm going to save it to device 8, and we're going to start at address 1C000 and we're going to end at address 1C81. The reason I added one here instead of 1C080 is because it's not inclusive. The last value does not get included in the save.

14:18 All right, the file has been saved to disk. Now if I do a cold boot, it will clear out everything in memory. The REU file will get automatically loaded back into the REU by the Ultimate 2+. So I hit F1 with my knuckle there, but that's fine. We can see our file that got saved there: 1C000. We will enter the monitor again and we'll load that file. And the syntax is the file name, the device, and the memory space we want to load it into. There we go. And now we can verify that it's there by taking a look at 1C000 again. Okay, cool, GEOS boot. So we have the boot loader code loaded back into memory exactly where it was. Now we want to do a soft reset and see if the machine boots into GEOS.

15:15 Okay, that confirms that GEOS auto-boot doesn't work like a cartridge, and we're definitely dealing with something else here. In fact, we're kind of at a dead end. What do we go next? Well, if we go back to the addendum, we can see down here one thing that we kind of did gloss over. In addition to the memory space between C000 and C080, the NMI vector has to be unchanged for the reboot to work. So maybe there's a clue about what we should look at next.

15:45 Here is the Comm 128 Programmer's Reference Guide. And here on page 407, we can see all there is to know about C128 system vectors. Down here we've got the NMI vector. "The non-maskable interrupt vector is activated whenever the processor NMI pin detects a negative edge. There are two possible sources of NMIs under normal conditions: the restore key being pressed or RS232 I/O." Okay, it doesn't sound like either of those is what we're interested in here. But there's more stuff here to look at, including this System Operating Vector up here. And note that it's in RAM one. "The system vector and accompanying key string provide application software with a means of regaining system control after a hardware reset." Okay, that sounds like something we're interested in. "The key string provides the distinction between a warm reset and a cold power up. The CBM key is installed, and the system vector is set to C128 mode. If the key is found, the system vector is moved to common RAM at 02 and an indirect jump is performed." So we have this location FFF5 where we should find the "CBM" string. And then we have the low byte and high byte of the system vector here in FFF8 and FFF9 where the machine will jump to if it finds that "CBM" string. So this kind of looks like it works like a cartridge but in system RAM instead. So maybe this is what we're actually interested in, and maybe the GEOS manual was wrong about which vector it's talking about.

17:23 So let's take a look at that memory location. Once again, I've got GEOS loaded up here. We'll just quit back to basic so that all the state is exactly where we need it to be. Go into the monitor and let's take a look at 1FFF5. Remember this is RAM one according to the operating system manual. And there it is. There's the "CBM" string at 1FFF5. So that is the key that's installed. And then the operating system vector is pointing to the two bytes that are following "CBM." So we have E4, which is the low byte, and 03, which is the high byte. So at 03E4, we should find whatever the system is going to jump to when this code executes. So let's take a look at the vector in 03E4. Okay, there's something here, but we can't tell what it is. Let's disassemble it.

18:22 Okay, so what this is doing is it's loading the value 7E hex into the accumulator and then it's storing the accumulator into address FF00. FF00 is not a place in RAM. It's actually the MMU configuration register. So we need to see what that does.

18:41 So here in the reference manual, "the configuration register is the most important register in the MMU. It specifies and organizes the ROM, RAM, and input/output configurations for the entire Comm 128 memory. In C128 mode, it's not used in C64 mode because of the PLA." And we have a bunch of addresses, and then we have a bunch of bits. It says what bit zero does: "the configuration register specifies I/O registers are available or whether ROM is present." If we move on, we've got bit one, bit two, bit four, five, so it describes what each of the bits in the configuration register do. But if we just jump ahead a page, we've got this nice little table which tells us exactly what the configuration register is doing.

19:26 The first thing we need to know is that that 7E in hex translates to 01111110 in binary. Now, if we match that up to what each of the bits do in the configuration register, starting at this low bit zero here, indicates that we're using an I/O register instead of RAM and ROM. So we're going to have access to the input/output, the devices attached to the system. The one in this bit indicates that we're swapping the basic ROM low for RAM. The 11 here in bits two and three indicate that we're swapping basic ROM high for RAM. In bits four and five, we're swapping kernel ROM for RAM. And then in bits six and seven, we have a 01 which means we're configuring the MMU to use a RAM bank one. So in effect, sending 7E to address FF00 tells it that we want I/O, we want to swap out basic and kernel for RAM, and we want to use RAM bank one. So that is what that bit of code is doing when it sets up the machine. If we look back at the next step, it's jumping to C000, but that's really 1C000 because we've just set the MMU to look at bank one. And that, if you remember, is the address for the GEOS bootloader that we looked at originally.

20:46 Okay, it's all starting to come together here. So let's save both the operating system vector and this little snippet that sets up the MMU and then jumps to the boot code. I'm going to save 1FFF5 on device 8 from 1FFF5 to 1FFFA. Remember, I've added one. And I'm also going to save 03E4 to device 8 from 03E4 to 03EC. I've added one again.

21:24 All right, with that done, I can hard reset the machine. Once again, the REU file is going to be automatically loaded into the Ultimate 2+, and now I could go back into the monitor like I did before and load all three of those files one at a time to put them back into memory. But let's simplify that process with a short basic program. What I'm going to use is the BLOAD command, which allows us to load a binary file and also specify which bank we want to deposit it into. So we're going to load 1C000 into bank one. We're going to load 1FFF5 into bank one. And then we're going to load 03E4 into bank zero. We don't need to specify zero; it's the default. And we'll save this as REUBOOT on drive 8.

22:22 All right, now if I run the program, it should load all three of those files into the correct location in memory. And now let's hit reset. Huh. All right, well, that's odd. It kind of looks like our machine is crashed. And my first inclination would be to power it off and, you know, see what we've done wrong. Maybe I saved the wrong memory addresses, or maybe I didn't load all the files correctly. And believe me, I did that several times under testing. But if we wait just a minute... now that looks more like it. There we go. GEOS has just booted from the RAM disk without us typing anything to load it from disk. There was some weirdness, which it didn't happen when I tested this in VICE, so it may be related to the Ultimate 2+. I tried changing the F timing and the edge recovery, and I disabled the command interface. I tried every permutation of settings that seemed relevant, and I couldn't get it to not do that funky screen with all the flashing characters. But if we reset it now, the second time you reset, whatever glitch was there before has been fixed because it's booting instantly and working just fine. So that's pretty cool. We've got it to work. It's not working perfectly, but it's working much better than it was before. So we've got all of the RAM addresses, we've got the REU snapshot, we've got the thing auto-booting. That's a great start.

24:08 But for comparison, let's take a look at the snapshot I made in VICE. And to do that, what I'm going to do is pull out this USB stick and put in this USB stick instead. Pop over to my Telnet session here and reconnect. I'm going to load the VICE REU into memory just like that. And now if I run our REU boot program that we just created and I hit reset... Okay, a little weird, but it seems to have worked just fine. There's no 5, 10, 15 seconds of weirdness. It was just a little bit of corrupt screen and then it worked right away. So something about the VICE REU is working fine, whereas the 1541 Ultimate REU dump is not working fine. So clearly there's something different about how those two things create their dumps.

25:10 So let's take a look real quick at the difference between the two dump files. Here I'm going to quit out of the Telnet session, and I've got all those REU dumps here. Let's just do a side-by-side diff of the hex dump. Oops, the hex dump of the U2+ REU and compare that to the hex dump of the VICE REU. Okay, so most of it looks the same. We've got a different line here at byte B0 or address B0. Something different there. We've got one byte difference there. And then if we scroll down further... those all look the same. Okay, here's something different. In the 1541, we have a bunch of random data, whereas the VICE, we have a bunch of ordered data. And what I suspect is this is unused area of the REU, and VICE is initializing it with kind of ordered nothing, whereas the Ultimate 2+ is initializing it with garbage. So I'm not sure that's really what's causing the problem, but it may be that the random data is tripping up GEOS and it's kind of going through the junk trying to figure out if there's anything there, which is why it takes so long to boot.

26:35 Let's take a look at some fresh dumps. We look at just a fresh dump from the Ultimate 2+. This is initialized before GEOS has ever loaded, and you can see it's just completely full of random stuff. If we do the same thing with the VICE file, you can see that it's just ordered nothing all the way through from start to finish. So they are creating their REUs empty in a different way. I'm not sure that is actually what's going on. And the reason I'm not sure about that is if we switch back to our machine here that's running the VICE image, and I power cycle the machine, I turn it back on, and we reconnect with Telnet, we load that VICE REU back into memory, and then we run our REU boot program once more, and if we hit reset... yeah, it's been corrupted. It no longer boots right away. Something has happened that's causing the REU images to become corrupted even when you don't save them. So I'm not sure what's going on. I've done a lot of research and testing behind the scenes, but I'm going to do some more investigation before I open a bug ticket for the 1541 Ultimate 2+. If you guys have any ideas what might be causing this, by all means, let me know in the comments. But either way, that was a fun exercise and we got to learn a little bit about the 128's memory and various ways it can auto-boot software.

28:40 Matt from the future here. So I've tried a few more things just to eliminate them as possible factors. First, I put together a small program that fills all 512K of the Ultimate's REU with zeros before running GEOS for the first time, just to see if the random bytes were the issue. I also tried three different USB thumb drives as well as creating the REU dump directly in the Ultimate's onboard flash storage in order to bypass USB altogether. Next, I compared the MD5 hash of the original VICE REU dump to the corrupt file on the USB stick, and they were the same, which indicates the contents of the file were not actually changed. I'm still at a loss as to what's going on unless the U2+ is storing some additional REU state internally, but I'll keep at it. Please let me know if you have any ideas.

29:31 Okay, back to the video. Before we wrap up, I wanted to point something out that there's really no need to jump through all these hoops, because GEOS 128 provides all of that functionality for us. If we just run "128 RBOOT" from the GEOS disk when our REU state has been restored, for example, if you have a battery-backed up REU like a RAMlink, you can just use this, and you will instantly get back into GEOS. Well, minus the corrupted REU file, but it will work and you don't need to write your own code, you don't need to be looking in the monitor to figure out where the code is. But that was still a fun exercise, and I hope you guys enjoyed the little tutorial today.

30:17 With the faster CPU, RGB graphics, and the speed of the REU, GEOS was really an amazing operating system, punching way above its weight on the humble 128. What about the 64 though? Well, it has no U36 option ROM or MMU, so it can't auto-boot without a cartridge. But it can use an REU to fast boot just like the 128, and I'll demonstrate this someday or year when I finally get around to making an episode about GEOS Megapatch.

30:45 I hope you enjoyed this bit. Thank you so much for watching, and we'll see you next time.

30:50 I don't know what I'm going to do. My GEOS takes so long to boot. If I just had an REU, then all my dreams would then come true. REU, REU, without one, apps just run like poo. REU, REU, please DMA my great sky blue. REU, REU, sonic scroll will make you true. REU, REU, like, subscribe, and comment too.
